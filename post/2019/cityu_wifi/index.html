<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>The Weird CityU WIFI Network - HE Fang - Some where to write something</title><meta name=renderer content="webkit"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><meta name=theme-color content="#f8f5ec"><meta name=msapplication-navbutton-color content="#f8f5ec"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec"><meta name=author content="He Fang"><meta name=description content="Recently when I checked the system journals, I found a lot of spams generated by my WIFI connection like these"><meta name=generator content="Hugo 0.71.0 with theme even"><link rel=canonical href=https://h3fang.github.io/post/2019/cityu_wifi/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link href=/sass/main.min.ea4964c050661c4f118424fddb3568261f6ce71ba01cbdf5d1b173db940158df.css rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css crossorigin=anonymous><meta property="og:title" content="The Weird CityU WIFI Network"><meta property="og:description" content="Recently when I checked the system journals, I found a lot of spams generated by my WIFI connection like these"><meta property="og:type" content="article"><meta property="og:url" content="https://h3fang.github.io/post/2019/cityu_wifi/"><meta property="article:published_time" content="2019-09-03T00:00:00+00:00"><meta property="article:modified_time" content="2019-09-16T00:00:00+00:00"><meta itemprop=name content="The Weird CityU WIFI Network"><meta itemprop=description content="Recently when I checked the system journals, I found a lot of spams generated by my WIFI connection like these"><meta itemprop=datePublished content="2019-09-03T00:00:00+00:00"><meta itemprop=dateModified content="2019-09-16T00:00:00+00:00"><meta itemprop=wordCount content="877"><meta itemprop=keywords content="linux,wifi,networkmanager,"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Weird CityU WIFI Network"><meta name=twitter:description content="Recently when I checked the system journals, I found a lot of spams generated by my WIFI connection like these"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script><script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]--></head><body><div id=mobile-navbar class=mobile-navbar><div class=mobile-header-logo><a href=/ class=logo>He Fang</a></div><div class=mobile-navbar-icon><span></span><span></span><span></span></div></div><nav id=mobile-menu class="mobile-menu slideout-menu"><ul class=mobile-menu-list><a href=/><li class=mobile-menu-item>Home</li></a><a href=/post/><li class=mobile-menu-item>Archives</li></a><a href=/tags/><li class=mobile-menu-item>Tags</li></a><a href=/categories/><li class=mobile-menu-item>Categories</li></a><a href=/about/><li class=mobile-menu-item>About</li></a></ul></nav><div class=container id=mobile-panel><header id=header class=header><div class=logo-wrapper><a href=/ class=logo><img src=/favicon.ico alt=logo style=margin-right:16px>He Fang</a></div><nav class=site-navbar><ul id=menu class=menu><li class=menu-item><a class=menu-item-link href=/>Home</a></li><li class=menu-item><a class=menu-item-link href=/post/>Archives</a></li><li class=menu-item><a class=menu-item-link href=/tags/>Tags</a></li><li class=menu-item><a class=menu-item-link href=/categories/>Categories</a></li><li class=menu-item><a class=menu-item-link href=/about/>About</a></li></ul></nav></header><main id=main class=main><div class=content-wrapper><div id=content class=content><article class=post><header class=post-header><h1 class=post-title>The Weird CityU WIFI Network</h1><div class=post-meta><span class=post-time>2019-09-03</span>
<span class=more-meta>877 words</span>
<span class=more-meta>5 mins read</span></div></header><div class=post-toc id=post-toc><h2 class=post-toc-title>Contents</h2><div class="post-toc-content always-active"><nav id=TableOfContents><ul><li><a href=#short-dhcp-lease-time>Short DHCP Lease Time</a></li><li><a href=#proactive-key-caching>Proactive Key Caching</a></li><li><a href=#update-2019-09-04>Update (2019-09-04)</a></li><li><a href=#update-2019-09-16>Update (2019-09-16)</a></li><li><a href=#references>References</a></li></ul></nav></div></div><div class=post-content><p>Recently when I checked the system journals, I found a lot of spams generated by my WIFI connection like these</p><div class=align-center><p><img src=/image/NetworkManager-dhcp4.webp alt></p><p><img src=/image/wpa-supplicant-PMKSA-CACHE.webp alt></p></div><h2 id=short-dhcp-lease-time>Short DHCP Lease Time</h2><p>The first one is weird. How is DHCP lease time only 120 seconds?! This way, the DHCP client will try to renew the lease about every minute. Every time the DHCP client tries to renew the lease, it will increase my laptop power consumption and spam useless messages into the system journal, making it harder to find potentially important journal logs, increase disk usage/load and further reduce the laptop battery life. The default DHCP lease time for <code>dhclient</code> is 2 hours, other common values are 6 hours, 24 hours, 1 week, etc. Anyway, much longer than 120 seconds. I guess the CityU IT staff uses a very short lease time to free disconnected IP addresses as soon as possible, since there are so may devices trying to connect and the IP address pool is limited.</p><p>I tried to request for a longer DHCP lease time by explicitly setting it in <code>dhclient</code> configuration file.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>$ cat /etc/dhclient.conf
send dhcp-lease-time 7200<span class=p>;</span>
</code></pre></td></tr></table></div></div><p>This doesn&rsquo;t change anything. Then I decided to override this setting, since I am sitting in the lab using my laptop basically like a desktop all day.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>$ cat /etc/dhclient.conf
supersede dhcp-lease-time 7200<span class=p>;</span>
</code></pre></td></tr></table></div></div><p>This kind of works, until the first day of the new semester. Every now and then, I lost internet connection and have to reconnect the WIFI. I thought there are so many devices trying to connect to WIFI, the DHCP server can no longer reserve the IP address for me if I only renew it every two hours. So I reverted the changes to <code>dhclient</code> configuration. But when I checked the system journal, I found that the IP address assigned to my laptop were the same before and after the configuration change.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>$ journalctl -b -2 <span class=p>|</span> grep dhcp4 <span class=p>|</span> grep address
</code></pre></td></tr></table></div></div><div class=align-center><p><img src=/image/dhcp4-addresses.webp alt></p></div><p>So the DHCP server did not assign the IP address to another client. I don&rsquo;t know what happened. My wild guess is that it is using DHCP lease renewal as some kind of heartbeat detection, if you don&rsquo;t respond (try to renew the lease) it will drop your connection when the traffic is crowded. I don&rsquo;t have a good solution to this since this is a server side decision, I either accept or refuse to use the WIFI.</p><h2 id=proactive-key-caching>Proactive Key Caching</h2><p>The second one is also weird. A quick search shows that PMKSA-CACHE enables fast switch between access points. But why NetworkManager rescans about every 30 seconds and generates so many useless journal logs? The fast switch is useful for mobile phones, since you can walk pass a few access points while video chatting with your friends. It&rsquo;s hard to imagine anyone would move quickly with his/her laptop while working with the internet.</p><p>I think the easy solution is to disable PMKSA-CACHE. But NetworkManager actually <a href=https://gitlab.freedesktop.org/NetworkManager/NetworkManager/commit/f1f0ada0c614f1e1353d271e345feb3fafa9d7e7>always enables</a> proactive key caching for WPA Enterprise connections. So I have to patch the source code to disable it. That&rsquo;s too much work to do. I will just leave it as default (for now).</p><h2 id=update-2019-09-04>Update (2019-09-04)</h2><p>I have found a workaround to disable the enforced proactive key caching function, by using a specific BSSID for your WIFI connection.</p><p>We can list all the BSSIDs around us for the WIFI SSID (for my case <strong>CityU WLAN (WPA)</strong>) by using</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell>$ nmcli -f SSID,BSSID,SIGNAL,ACTIVE,FREQ dev wifi list --rescan yes <span class=p>|</span> grep <span class=s2>&#34;CityU WLAN (WPA)&#34;</span>
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:40  <span class=m>100</span>     no      <span class=m>2412</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:00  <span class=m>94</span>      no      <span class=m>2437</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:10  <span class=m>75</span>      yes     <span class=m>5785</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:A0  <span class=m>70</span>      no      <span class=m>2412</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:40  <span class=m>64</span>      no      <span class=m>2437</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:A0  <span class=m>57</span>      no      <span class=m>2462</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:A0  <span class=m>55</span>      no      <span class=m>2412</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:E1  <span class=m>54</span>      no      <span class=m>2412</span> MHz
CityU WLAN <span class=o>(</span>WPA<span class=o>)</span>    xx:xx:xx:xx:xx:F1  <span class=m>49</span>      no      <span class=m>5240</span> MHz
</code></pre></td></tr></table></div></div><p>Choose a BSSID (the MAC address of the access point) that is good for you (strong signal strength, 2.4G or 5G).</p><p>Then specify the BSSID for your WIFI profile (if you use <code>NetworkManager</code> and <code>nm-applet</code>).</p><div class=align-center><p><img src=/image/NetworkManager-BSSID.webp alt></p></div><p>The downside of this workaround is that your WIFI will <strong>NOT</strong> connect to any other access points for the same SSID. So if you moved your laptop to a new place (thus a different access point), remember to specify a new BSSID or just remove the specified BSSID.</p><h2 id=update-2019-09-16>Update (2019-09-16)</h2><p>The excessive log messages from NetworkManager DHCP component and wpa_supplicant are really annoying. The system journal is filled with useless messages and the real important log messages are discarded, since I set the 50M journal file size limit.</p><p>To suppress NetworkManager DHCP log messages lower than <em>warning</em> level, we can set</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ sudo nmcli general logging level WARN domain DHCP
</code></pre></td></tr></table></div></div><p>To make this consistent after boot, we can add a configuration file for NetworkManager by using</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> -e <span class=s1>&#39;[logging]\nlevel=WARN\ndomains=DHCP&#39;</span> <span class=p>|</span> sudo tee /etc/NetworkManager/conf.d/dhcp-logging.conf
</code></pre></td></tr></table></div></div><p>To suppress wpa_supplicant log messages lower than <em>warning</em> level we can override the systemd service unit with</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bash data-lang=bash>$ <span class=nb>echo</span> -e <span class=s1>&#39;[Service]\nLogLevelMax=4&#39;</span> <span class=p>|</span> sudo <span class=nv>SYSTEMD_EDITOR</span><span class=o>=</span>tee systemctl edit wpa_supplicant.service
</code></pre></td></tr></table></div></div><p>Finally I get a more meaningful system journal (filled with errors ðŸ˜‚).</p><h2 id=references>References</h2><ul><li><a href=https://stackoverflow.com/questions/29966496/dhclient-override-renewal-time>https://stackoverflow.com/questions/29966496/dhclient-override-renewal-time</a></li><li><a href=https://gitlab.freedesktop.org/NetworkManager/NetworkManager/commit/f1f0ada0c614f1e1353d271e345feb3fafa9d7e7>https://gitlab.freedesktop.org/NetworkManager/NetworkManager/commit/f1f0ada0c614f1e1353d271e345feb3fafa9d7e7</a></li></ul></div><div class=post-copyright><p class=copyright-item><span class=item-title>Author</span>
<span class=item-content>He Fang</span></p><p class=copyright-item><span class=item-title>LastMod</span>
<span class=item-content>2019-09-16</span></p><p class=copyright-item><span class=item-title>License</span>
<span class=item-content><a rel="license noopener" href=https://creativecommons.org/licenses/by-nc-nd/4.0/ target=_blank>CC BY-NC-ND 4.0</a></span></p></div><footer class=post-footer><div class=post-tags><a href=/tags/linux/>linux</a>
<a href=/tags/wifi/>wifi</a>
<a href=/tags/networkmanager/>networkmanager</a></div><nav class=post-nav><a class=prev href=/post/2019/vim_save_as_root/><i class="iconfont icon-left"></i><span class="prev-text nav-default">Save as root in non-root vim</span>
<span class="prev-text nav-mobile">Prev</span></a>
<a class=next href=/post/2019/tilde_vs_home/><span class="next-text nav-default">~ vs $HOME</span>
<span class="next-text nav-mobile">Next</span>
<i class="iconfont icon-right"></i></a></nav></footer></article></div><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname==='localhost')return;var dsq=document.createElement('script');dsq.type='text/javascript';dsq.async=true;var disqus_shortname='h3fang';dsq.src='//'+disqus_shortname+'.disqus.com/embed.js';(document.getElementsByTagName('head')[0]||document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></main><footer id=footer class=footer><div class=social-links><a href=mailto:hf.enigma@gmail.com class="iconfont icon-email" title=email></a><a href=https://twitter.com/hfenigma class="iconfont icon-twitter" title=twitter></a><a href=https://github.com/h3fang class="iconfont icon-github" title=github></a><a href=https://h3fang.github.io/feed.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a></div><div class=copyright><span class=power-by>Powered by <a class=hexo-link href=https://gohugo.io>Hugo</a></span>
<span class=division>|</span>
<span class=theme-info>Theme -
<a class=theme-link href=https://github.com/h3fang/hugo-theme-even>Even</a></span>
<span class=copyright-year>&copy;
2019 -
2020
<span class=heart><i class="iconfont icon-heart"></i></span><span class=author>He Fang</span></span></div></footer><div class=back-to-top id=back-to-top><i class="iconfont icon-up"></i></div></div><script src=https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js crossorigin=anonymous></script><script type=text/javascript src=/js/main.min.5884e86a3c9b0bf4c11ca51f6ed54c6336cf80562ac042643159f79c6cc6d6f4.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-144488536-1','auto');ga('set','anonymizeIp',true);ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>